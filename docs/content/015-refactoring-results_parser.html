

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Refactoring results_parser.py &mdash; WayneCountyDeedsApp Notes 0.2.0 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://kat-alo.github.io/deed-scrapercontent/015-refactoring-results_parser.html"/>
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Intro to unit-testing and test-driven development" href="tdd/002-tdd-basics.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../index.html" class="icon icon-home"> WayneCountyDeedsApp Notes
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="001-first-notes.html">First codebase lookover</a></li>
<li class="toctree-l1"><a class="reference internal" href="002-overhaul-overview.html">Overview of codebase overhaul</a></li>
<li class="toctree-l1"><a class="reference internal" href="002-overhaul-overview.html#inventory">Inventory</a></li>
<li class="toctree-l1"><a class="reference internal" href="tdd/001-pytest-basics.html">Intro to testing in Python and pytest</a></li>
<li class="toctree-l1"><a class="reference internal" href="tdd/002-tdd-basics.html">Intro to unit-testing and test-driven development</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Refactoring results_parser.py</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview-of-the-original-code">Overview of the original code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parsing-html-with-lxml">Parsing HTML with lxml</a></li>
<li class="toctree-l2"><a class="reference internal" href="#full-code-references">Full code references</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">WayneCountyDeedsApp Notes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Refactoring results_parser.py</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/content/015-refactoring-results_parser.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="refactoring-results-parser-py">
<h1>Refactoring results_parser.py<a class="headerlink" href="#refactoring-results-parser-py" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview-of-the-original-code">
<h2>Overview of the original code<a class="headerlink" href="#overview-of-the-original-code" title="Permalink to this headline">¶</a></h2>
<p>Good parts:</p>
<ul class="simple">
<li>Having parse_row() be a function that simply takes in raw HTML and returns a useful <code class="docutils literal notranslate"><span class="pre">dict</span></code> object.</li>
</ul>
<p>Places for improvement:</p>
<ul class="simple">
<li>Don’t repeat yourself</li>
<li>Doing too much in one function</li>
<li>Avoid using regexes when you can parse HTML</li>
</ul>
<div class="section" id="data-extraction-methods">
<h3>Data extraction methods<a class="headerlink" href="#data-extraction-methods" title="Permalink to this headline">¶</a></h3>
<p>Some things require just a regex of a text snippet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_muni</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Muni:)(.*)(?=Address:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="n">muni</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">muni</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">muni</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">muni</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_rec_date</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Rec Date: )(.*)(?=L:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>
</div>
<p>Others just simple string splitting, because you think you know where the newlines are going t be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_doc_number</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">row_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_doc_type</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">row_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="parsing-html-with-lxml">
<h2>Parsing HTML with lxml<a class="headerlink" href="#parsing-html-with-lxml" title="Permalink to this headline">¶</a></h2>
<p>One of the most famous StackOverflow answers is a rant on the <a class="reference external" href="https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags">futility of trying to parse HTML with just regexes</a>. Even when the text pattern is seemingly simple to capture, it’s still almost always better to do the extra work of using a HTML parser for the headaches it saves you when the text is more unpredictable than expected.</p>
<p><a class="reference external" href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">BeautifulSoup</a> and <a class="reference external" href="https://lxml.de/">lxml</a> are both solid choices for HTML parsing in Python. However, I like the latter because</p>
<p>Both support the use of CSS selectors for targeting</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="n">HTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;h1&gt;&lt;a href=&quot;example.com&quot;&gt;Site&lt;/a&gt;&#39;&#39;&#39;</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">HTML</span><span class="p">)</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
<span class="n">sitename</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>lxml</strong> tends to be slightly more verbose and formal:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lxml.html</span> <span class="kn">import</span> <span class="n">fromstring</span> <span class="k">as</span> <span class="n">hparse</span>
<span class="n">HTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;h1&gt;&lt;a href=&quot;example.com&quot;&gt;Site&lt;/a&gt;&#39;&#39;&#39;</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">hparse</span><span class="p">(</span><span class="n">HTML</span><span class="p">)</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
<span class="n">sitename</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
</pre></div>
</div>
<p>Both libraries are both very similar, and different in ways too small to recount here, though <strong>bs4</strong> is probably more human-friendly at first. But to me, the one clear advantage of <strong>lxml</strong> is that it supports <a class="reference external" href="https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-4.0/ms256086(v=vs.100)">XPath expressions</a>, which is a powerful (if sometimes confusing) syntax for HTML/XML parsing (<a class="reference external" href="https://devhints.io/xpath">cheatsheet</a>) :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;h1&gt;&lt;a href=&quot;example.com&quot;&gt;Site&lt;/a&gt;&#39;&#39;&#39;</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">hparse</span><span class="p">(</span><span class="n">HTML</span><span class="p">)</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//h1/a/@href&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sitename</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//h1/a/text()&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Admittedly, the search result parsing doesn’t really need XPath’s power. In <a class="reference internal" href="#script-search-results-parser-py"><span class="std std-ref">search_results_parser.py</span></a>, I use it in <code class="docutils literal notranslate"><span class="pre">_extract_record_url()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_extract_record_url</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<span class="hll">  <span class="n">href</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;./td[1]/strong/a[1]/@href&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span>  <span class="k">return</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">BASE_ENDPOINT</span><span class="p">,</span> <span class="n">href</span><span class="p">)</span>
</pre></div>
</div>
<p>This is what it would look like with CSS selectors (<code class="docutils literal notranslate"><span class="pre">r</span></code> being a <code class="docutils literal notranslate"><span class="pre">lxml.Element</span></code>, i.e. parsed HTML):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
    <span class="n">href</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="s1">&#39;td:first-child strong a:first-child&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>A better demo of XPath’s functionality is in the</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">tr</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;even&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">td</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;&lt;</span><span class="n">strong</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;../eagleweb/viewDoc.jsp?node=DOCCL-20093323&quot;</span><span class="o">&gt;</span><span class="n">WARRANTY</span> <span class="n">DEED</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span>
    <span class="mi">201020860</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">strong</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">td</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;../eagleweb/viewDoc.jsp?node=DOCCL-20093323&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">table</span> <span class="n">border</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">cellspacing</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="o">&gt;&lt;</span><span class="n">tbody</span><span class="o">&gt;&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">nowrap</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Rec</span> <span class="n">Date</span><span class="p">:</span> <span class="mi">12</span><span class="o">/</span><span class="mi">27</span><span class="o">/</span><span class="mi">2000</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">L</span><span class="p">:</span> <span class="mi">33007</span> <span class="n">P</span><span class="p">:</span> <span class="mi">637</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;50%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Grantor</span><span class="p">:</span> <span class="n">COMMERCE</span> <span class="n">CONSTRUCTION</span> <span class="n">CO</span> <span class="n">INC</span> <span class="p">,</span> <span class="n">FOUNTAIN</span> <span class="n">HOMES</span>  <span class="n">DBA</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;50%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Grantee</span><span class="p">:</span> <span class="n">NGUYEN</span> <span class="n">MINH</span> <span class="n">D</span>     <span class="n">MARRIED</span><span class="p">,</span> <span class="n">NGUYEN</span> <span class="n">RACHAEL</span> <span class="n">E</span> <span class="n">HW</span>     <span class="n">MARRIED</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;&lt;/</span><span class="n">tbody</span><span class="o">&gt;&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">table</span> <span class="n">border</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">cellspacing</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="o">&gt;&lt;</span><span class="n">tbody</span><span class="o">&gt;&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;20%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Muni</span><span class="p">:</span> <span class="n">BROWNSTOWN</span> <span class="n">TOWNSHIP</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;20%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Address</span><span class="p">:</span> <span class="mi">23596</span> <span class="n">STACEY</span> <span class="n">DR</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;20%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span> <span class="n">Tax</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">70065040291000</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;40%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span>    <span class="n">Subd</span><span class="p">:</span> <span class="n">FLOWERS</span> <span class="n">CREEK</span> <span class="n">NO</span> <span class="mi">3</span>   <span class="n">Liber</span><span class="p">:</span> <span class="mi">114</span>   <span class="n">Page</span><span class="p">:</span> <span class="mi">54</span>    <span class="n">Lot</span><span class="p">:</span> <span class="mi">291</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;&lt;/</span><span class="n">tbody</span><span class="o">&gt;&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">td</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">td</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="full-code-references">
<h2>Full code references<a class="headerlink" href="#full-code-references" title="Permalink to this headline">¶</a></h2>
<div class="section" id="results-parser-py">
<span id="script-results-parser-py"></span><h3>results_parser.py<a class="headerlink" href="#results-parser-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">bs4</span> <span class="k">import</span> <span class="n">BeautifulSoup</span>

<span class="n">CSV_HEADERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;document_type&#39;</span><span class="p">,</span> <span class="s1">&#39;document_number&#39;</span><span class="p">,</span> <span class="s1">&#39;rec_date&#39;</span><span class="p">,</span> <span class="s1">&#39;grantor&#39;</span><span class="p">,</span> <span class="s1">&#39;grantee&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;muni&#39;</span><span class="p">]</span>
<span class="n">RAW_DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;data/raw-html/&quot;</span>
<span class="n">PROCESSED_DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;data/processed-csv/&quot;</span>
<span class="n">ERROR_MESSAGE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NO HTML FILES AVAILABLE TO PARSE, CHECK OR REFINE SEARCH PARAMETERS.&quot;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_muni</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Muni:)(.*)(?=Address:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="n">muni</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">muni</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">muni</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">muni</span>

<span class="k">def</span> <span class="nf">get_address</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Address:)(.*)(?=Tax ID:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="n">address</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">address</span>

<span class="k">def</span> <span class="nf">get_grantee</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Grantee: )(.*)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="n">grantee</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">grantee</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">grantee</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grantee</span>

<span class="k">def</span> <span class="nf">get_grantor</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Grantor: )(.*)(?=Grantee:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="n">grantor</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">grantor</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">grantor</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grantor</span>

<span class="k">def</span> <span class="nf">get_rec_date</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Rec Date: )(.*)(?=L:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_doc_number</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">row_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_doc_type</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">row_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">clean_row</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">first_col_text</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>

    <span class="n">doc_type</span> <span class="o">=</span> <span class="n">get_doc_type</span><span class="p">(</span><span class="n">first_col_text</span><span class="p">)</span>
    <span class="n">doc_number</span> <span class="o">=</span> <span class="n">get_doc_number</span><span class="p">(</span><span class="n">first_col_text</span><span class="p">)</span>

    <span class="n">second_col_text</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;td:nth-of-type(2)&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
    <span class="n">sec_col_first_row</span> <span class="o">=</span> <span class="n">second_col_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sec_col_sec_row</span> <span class="o">=</span> <span class="n">second_col_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">rec_date</span> <span class="o">=</span> <span class="n">get_rec_date</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="n">grantor</span> <span class="o">=</span> <span class="n">get_grantor</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="n">grantee</span> <span class="o">=</span> <span class="n">get_grantee</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">get_address</span><span class="p">(</span><span class="n">sec_col_sec_row</span><span class="p">)</span>
    <span class="n">muni</span> <span class="o">=</span> <span class="n">get_muni</span><span class="p">(</span><span class="n">sec_col_sec_row</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;doc type is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">doc_type</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;doc number is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">doc_number</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rec date is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rec_date</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;grantor is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">grantor</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;grantee is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">grantee</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;address is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">address</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;muni is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">muni</span><span class="p">)</span>

    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc_type</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc_number</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec_date</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grantor</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grantee</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">muni</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-----------------------------------&quot;</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">clean_row</span>

<span class="k">def</span> <span class="nf">html_to_csv</span><span class="p">(</span><span class="n">name_hyphenated</span><span class="p">):</span>

    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">RAW_DATA_DIR</span> <span class="o">+</span> <span class="n">name_hyphenated</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;.html&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="n">csv_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">CSV_HEADERS</span><span class="p">]</span>

    <span class="c1">#if there aren&#39;t any filenames, handle it</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">csv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ERROR_MESSAGE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="n">file</span>

            <span class="n">file_to_soupify</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">file_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">file_to_soupify</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">file_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;searchResultsTable&quot;</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;odd&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;even&#39;</span><span class="p">]:</span>
                    <span class="n">clean_row</span> <span class="o">=</span> <span class="n">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">csv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_row</span><span class="p">)</span>

    <span class="n">csv_filename</span> <span class="o">=</span> <span class="n">PROCESSED_DATA_DIR</span> <span class="o">+</span> <span class="n">name_hyphenated</span> <span class="o">+</span> <span class="s1">&#39;-rod-results.csv&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_list</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">html_to_csv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>









</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="search-results-parser-py">
<span id="script-search-results-parser-py"></span><h3>search_results_parser.py<a class="headerlink" href="#search-results-parser-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">config</span> <span class="k">import</span> <span class="n">BASE_ENDPOINT</span><span class="p">,</span> <span class="n">hparse</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="k">import</span> <span class="n">urljoin</span>

<span class="n">_DATA_SEL</span> <span class="o">=</span> <span class="s1">&#39;tr &gt; td:nth-child(2) table td&#39;</span>


<span class="k">def</span> <span class="nf">_extract_grantor</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="n">_DATA_SEL</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^Grantor: *(.+)&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s{3,}&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_extract_grantee</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="n">_DATA_SEL</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^Grantee: *(.+)&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s{3,}&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_extract_rec_date</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">rectxt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="n">_DATA_SEL</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^Rec Date: *(\d</span><span class="si">{2}</span><span class="s1">)/(\d</span><span class="si">{2}</span><span class="s1">)/(\d</span><span class="si">{4}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">rectxt</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_extract_record_url</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
  <span class="n">href</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;./td[1]/strong/a[1]/@href&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">BASE_ENDPOINT</span><span class="p">,</span> <span class="n">href</span><span class="p">)</span>


<span class="n">RESULT_FIELDS</span> <span class="o">=</span>  <span class="p">{</span>
  <span class="s1">&#39;document_type&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="s1">&#39;td strong a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;document_number&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="s1">&#39;td strong a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;rec_date&#39;</span><span class="p">:</span> <span class="n">_extract_rec_date</span><span class="p">,</span>
  <span class="s1">&#39;grantor&#39;</span><span class="p">:</span> <span class="n">_extract_grantor</span><span class="p">,</span>
  <span class="s1">&#39;grantee&#39;</span><span class="p">:</span> <span class="n">_extract_grantee</span><span class="p">,</span>
  <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Address: *(.+)&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="n">_DATA_SEL</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">())</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;muni&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Muni: *(.+)&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="n">_DATA_SEL</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">())</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">_extract_record_url</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">SEARCH_RESULT_HEADERS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">RESULT_FIELDS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">extract_field</span><span class="p">(</span><span class="n">fieldname</span><span class="p">,</span> <span class="n">el</span><span class="p">):</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">RESULT_FIELDS</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">el</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">txt</span>


<span class="k">def</span> <span class="nf">parse_result</span><span class="p">(</span><span class="n">el</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">fn</span><span class="p">:</span> <span class="n">extract_field</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">SEARCH_RESULT_HEADERS</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">parse_rows</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    txt: a string, presumably of HTML</span>

<span class="sd">    returns: a list of lxml.html.HtmlElement</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">hparse</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="s1">&#39;tr.odd, tr.even&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rows</span>


<span class="k">def</span> <span class="nf">parse_records_on_page</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    txt: a string, presumably of a full HTML page</span>

<span class="sd">    returns: list of dicts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_result</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">parse_rows</span><span class="p">(</span><span class="n">txt</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">records</span>


<span class="c1"># alias parse_records_on_page</span>
<span class="n">parse</span> <span class="o">=</span> <span class="n">parse_records_on_page</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="tdd/002-tdd-basics.html" class="btn btn-neutral float-left" title="Intro to unit-testing and test-driven development" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Dan Nguyen, Katlyn Alapati

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>