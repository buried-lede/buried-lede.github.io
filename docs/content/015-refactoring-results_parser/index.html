

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Refactoring results_parser.py &mdash; WayneCountyDeedsApp Notes 0.2.0 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://kat-alo.github.io/deed-scrapercontent/015-refactoring-results_parser/index.html"/>
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Intro to unit-testing and test-driven development" href="../tdd/002-tdd-basics.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../../index.html" class="icon icon-home"> WayneCountyDeedsApp Notes
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../001-first-notes.html">First codebase lookover</a></li>
<li class="toctree-l1"><a class="reference internal" href="../002-overhaul-overview.html">Overview of codebase overhaul</a></li>
<li class="toctree-l1"><a class="reference internal" href="../002-overhaul-overview.html#inventory">Inventory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tdd/001-pytest-basics.html">Intro to testing in Python and pytest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tdd/002-tdd-basics.html">Intro to unit-testing and test-driven development</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Refactoring results_parser.py</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview-of-the-original-code">Overview of the original code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-good-parts-of-results-parser-py">The good parts of results_parser.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-results-parser-py-has-been-split-up">How results_parser.py has been split up</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parsing-html-with-lxml">Parsing HTML with lxml</a></li>
<li class="toctree-l2"><a class="reference internal" href="#don-t-repeat-yourself-dry">Don’t repeat yourself (DRY)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#code-references">Code references</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">WayneCountyDeedsApp Notes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Refactoring results_parser.py</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/content/015-refactoring-results_parser/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="refactoring-results-parser-py">
<h1>Refactoring results_parser.py<a class="headerlink" href="#refactoring-results-parser-py" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#overview-of-the-original-code" id="id3">Overview of the original code</a><ul>
<li><a class="reference internal" href="#data-extraction-methods" id="id4">Data extraction methods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-good-parts-of-results-parser-py" id="id5">The good parts of results_parser.py</a><ul>
<li><a class="reference internal" href="#keeping-parsing-work-separate-from-exporting-work" id="id6">Keeping parsing work separate from exporting work</a></li>
<li><a class="reference internal" href="#having-individual-data-extraction-functions" id="id7">Having individual data extraction functions</a></li>
<li><a class="reference internal" href="#storing-the-list-of-exported-headers-as-a-constant" id="id8">Storing the list of exported headers as a constant</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-results-parser-py-has-been-split-up" id="id9">How results_parser.py has been split up</a></li>
<li><a class="reference internal" href="#parsing-html-with-lxml" id="id10">Parsing HTML with lxml</a><ul>
<li><a class="reference internal" href="#using-xpath-to-very-narrowly-specify-a-link-by-its-text" id="id11">Using xpath to very narrowly specify a link by its text</a></li>
</ul>
</li>
<li><a class="reference internal" href="#don-t-repeat-yourself-dry" id="id12">Don’t repeat yourself (DRY)</a><ul>
<li><a class="reference internal" href="#drying-up-the-text-cleaning-work" id="id13">DRYing up the text-cleaning work</a></li>
<li><a class="reference internal" href="#drying-up-the-html-parsing-text-extraction" id="id14">DRYing up the HTML parsing/text-extraction</a></li>
<li><a class="reference internal" href="#wrapping-it-up-into-a-loopable-sequence" id="id15">Wrapping it up into a loopable sequence</a></li>
<li><a class="reference internal" href="#mapping-fieldnames-to-their-respective-extraction-functions-with-a-dict" id="id16">Mapping fieldnames to their respective extraction functions with a dict</a><ul>
<li><a class="reference internal" href="#why-care-about-using-csv-dictwriter" id="id17">Why care about using csv.DictWriter</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#code-references" id="id18">Code references</a><ul>
<li><a class="reference internal" href="#results-parser-py" id="id19">results_parser.py</a></li>
<li><a class="reference internal" href="#search-results-parser-py" id="id20">search_results_parser.py</a></li>
<li><a class="reference internal" href="#example-results-row-html" id="id21">example-results-row.html</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview-of-the-original-code">
<h2><a class="toc-backref" href="#id3">Overview of the original code</a><a class="headerlink" href="#overview-of-the-original-code" title="Permalink to this headline">¶</a></h2>
<div class="section" id="data-extraction-methods">
<h3><a class="toc-backref" href="#id4">Data extraction methods</a><a class="headerlink" href="#data-extraction-methods" title="Permalink to this headline">¶</a></h3>
<p>Some things require just a regex of a text snippet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_muni</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Muni:)(.*)(?=Address:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="n">muni</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">muni</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">muni</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">muni</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_rec_date</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Rec Date: )(.*)(?=L:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>
</div>
<p>Others just simple string splitting, because you think you know where the newlines are going to be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_doc_number</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">row_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_doc_type</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">row_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-good-parts-of-results-parser-py">
<h2><a class="toc-backref" href="#id5">The good parts of results_parser.py</a><a class="headerlink" href="#the-good-parts-of-results-parser-py" title="Permalink to this headline">¶</a></h2>
<div class="section" id="keeping-parsing-work-separate-from-exporting-work">
<h3><a class="toc-backref" href="#id6">Keeping parsing work separate from exporting work</a><a class="headerlink" href="#keeping-parsing-work-separate-from-exporting-work" title="Permalink to this headline">¶</a></h3>
<p>Having <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code> be a function that simply takes in raw HTML and returns a useful <code class="docutils literal notranslate"><span class="pre">dict</span></code> object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">clean_row</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># ...</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">muni</span><span class="p">)</span>
    <span class="c1"># ...</span>
    <span class="k">return</span> <span class="n">clean_row</span>
</pre></div>
</div>
</div>
<div class="section" id="having-individual-data-extraction-functions">
<h3><a class="toc-backref" href="#id7">Having individual data extraction functions</a><a class="headerlink" href="#having-individual-data-extraction-functions" title="Permalink to this headline">¶</a></h3>
<p>Having separate functions – and naming them well – for particularly gnarly text-extraction work:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_rec_date</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Rec Date: )(.*)(?=L:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="storing-the-list-of-exported-headers-as-a-constant">
<h3><a class="toc-backref" href="#id8">Storing the list of exported headers as a constant</a><a class="headerlink" href="#storing-the-list-of-exported-headers-as-a-constant" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CSV_HEADERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;document_type&#39;</span><span class="p">,</span> <span class="s1">&#39;document_number&#39;</span><span class="p">,</span> <span class="s1">&#39;rec_date&#39;</span><span class="p">,</span> <span class="s1">&#39;grantor&#39;</span><span class="p">,</span> <span class="s1">&#39;grantee&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;muni&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Even though this might feel a little hacky, this is the right amount of “formal” work. The data pipeline doesn’t have to be that sophisticated yet, given the scope of the application and data; e.g. there’s only one data type (“deed record”, for now), it only has about 10 fields, and the end user of the exported data is someone manually using a spreadsheet, as opposed to another script or software program that would need to know how the schema is defined.</p>
<p>In a slightly more sophisticated pipeline – e.g. where there’s more data types, or if there’s like 20+ data fields – you might put this list of headers in a separate module. Or even in separate text file. But having a constant point to a list of strings is definitely good enough for now. The list is small enough to not clutter up the script that actually needs to refer to that list of fieldnames.</p>
<p>The section <a class="reference internal" href="#ref-mapping-fieldnames"><span class="std std-ref">Mapping fieldnames to their respective extraction functions with a dict</span></a> has more about how to improve on <code class="docutils literal notranslate"><span class="pre">CSV_HEADERS</span></code> as a place to define the data format.</p>
</div>
</div>
<div class="section" id="how-results-parser-py-has-been-split-up">
<h2><a class="toc-backref" href="#id9">How results_parser.py has been split up</a><a class="headerlink" href="#how-results-parser-py-has-been-split-up" title="Permalink to this headline">¶</a></h2>
<p>TKTK</p>
<p>The bulk of the functionality – mainly the parts that extracted data from HTML –  is contained in a script named <strong>waynecounty_deeds/search_results_parser.py</strong>, a copy of which is appended to this <a class="reference internal" href="#script-search-results-parser-py"><span class="std std-ref">page’s Code References section</span></a>.</p>
<hr class="docutils" />
<p>The main problem with <a class="reference internal" href="#script-results-parser-py"><span class="std std-ref">results_parser.py</span></a> is that it and its functions do too much work. It is not just parsing the HTML results, but it’s also responsible for exporting results to the specific format of CSV. Specifically, the <code class="docutils literal notranslate"><span class="pre">html_to_csv()</span></code> just does too much work:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">html_to_csv</span><span class="p">(</span><span class="n">name_hyphenated</span><span class="p">):</span>

    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">RAW_DATA_DIR</span> <span class="o">+</span> <span class="n">name_hyphenated</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;.html&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="n">csv_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">CSV_HEADERS</span><span class="p">]</span>

    <span class="c1">#if there aren&#39;t any filenames, handle it</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">csv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ERROR_MESSAGE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="n">file</span>

            <span class="n">file_to_soupify</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">file_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">file_to_soupify</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">file_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;searchResultsTable&quot;</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;odd&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;even&#39;</span><span class="p">]:</span>
                    <span class="n">clean_row</span> <span class="o">=</span> <span class="n">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">csv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_row</span><span class="p">)</span>

    <span class="n">csv_filename</span> <span class="o">=</span> <span class="n">PROCESSED_DATA_DIR</span> <span class="o">+</span> <span class="n">name_hyphenated</span> <span class="o">+</span> <span class="s1">&#39;-rod-results.csv&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_list</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="parsing-html-with-lxml">
<span id="lxml-primer"></span><h2><a class="toc-backref" href="#id10">Parsing HTML with lxml</a><a class="headerlink" href="#parsing-html-with-lxml" title="Permalink to this headline">¶</a></h2>
<p>One of the most famous StackOverflow answers is a rant on the <a class="reference external" href="https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags">futility of trying to parse HTML with just regexes</a>. Even when the text pattern is seemingly simple to capture, it’s still almost always better to do the extra work of using a HTML parser for the headaches it saves you when the text is more unpredictable than expected.</p>
<p><a class="reference external" href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">BeautifulSoup</a> and <a class="reference external" href="https://lxml.de/">lxml</a> are both solid choices for HTML parsing in Python.</p>
<p>Both support the use of CSS selectors for targeting:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="n">HTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;h1&gt;&lt;a href=&quot;example.com&quot;&gt;Site&lt;/a&gt;&#39;&#39;&#39;</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">HTML</span><span class="p">)</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
<span class="n">sitename</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>lxml</strong> tends to require more verbosity and explicitness:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lxml.html</span> <span class="kn">import</span> <span class="n">fromstring</span> <span class="k">as</span> <span class="n">hparse</span>
<span class="n">HTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;h1&gt;&lt;a href=&quot;example.com&quot;&gt;Site&lt;/a&gt;&#39;&#39;&#39;</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">hparse</span><span class="p">(</span><span class="n">HTML</span><span class="p">)</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
<span class="n">sitename</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
</pre></div>
</div>
<p>Both libraries are both very similar, and different in ways too small to recount here, though <strong>bs4</strong> is probably more human-friendly at first. But to me, the one clear advantage of <strong>lxml</strong> is that it supports <a class="reference external" href="https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-4.0/ms256086(v=vs.100)">XPath expressions</a>, which is a powerful (if sometimes confusing) syntax for HTML/XML parsing (<a class="reference external" href="https://devhints.io/xpath">cheatsheet</a>) :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;h1&gt;&lt;a href=&quot;example.com&quot;&gt;Site&lt;/a&gt;&#39;&#39;&#39;</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">hparse</span><span class="p">(</span><span class="n">HTML</span><span class="p">)</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//h1/a/@href&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sitename</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//h1/a/text()&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Admittedly, the search result parsing doesn’t really need XPath’s power. In <a class="reference internal" href="#script-search-results-parser-py"><span class="std std-ref">search_results_parser.py</span></a>, I use it in <code class="docutils literal notranslate"><span class="pre">_extract_record_url()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_extract_record_url</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<span class="hll">  <span class="n">href</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;./td[1]/strong/a[1]/@href&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span>  <span class="k">return</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">BASE_ENDPOINT</span><span class="p">,</span> <span class="n">href</span><span class="p">)</span>
</pre></div>
</div>
<p>This is what it would look like with CSS selectors (<code class="docutils literal notranslate"><span class="pre">r</span></code> being a <code class="docutils literal notranslate"><span class="pre">lxml.Element</span></code>, i.e. parsed HTML):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
    <span class="n">href</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="s1">&#39;td:first-child strong a:first-child&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="using-xpath-to-very-narrowly-specify-a-link-by-its-text">
<h3><a class="toc-backref" href="#id11">Using xpath to very narrowly specify a link by its text</a><a class="headerlink" href="#using-xpath-to-very-narrowly-specify-a-link-by-its-text" title="Permalink to this headline">¶</a></h3>
<div class="figure" id="id2">
<img alt="The 'Last' link in paginated search results" src="../../_images/wayne-rod-last-link.png" />
<p class="caption"><span class="caption-text">The ‘Last’ link in paginated search results for the Wayne County Register of Deeds website.</span></p>
</div>
<p>A more elaborate example of XPath’s functionality can be found in <a class="reference external" href="https://github.com/Kat-Alo/deed-scraper/blob/0.2.0/waynecounty_deeds/site_searcher.py">waynecounty_deeds/site_searcher.py</a>.</p>
<p>For example, this is how XPath is used to find the <strong>“Last”</strong> links when the results contain multiple pages <a class="reference external" href="https://github.com/Kat-Alo/deed-scraper/blob/0.2.0/waynecounty_deeds/site_searcher.py#L82">(line 82)</a> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_hrefs</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//form/span[@class=&quot;pagelinks&quot;][2]/a[text()=&quot;Last&quot;]/@href&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a <strong>very</strong> verbose, explicit way of replicating the selenium Browser instance method, <code class="docutils literal notranslate"><span class="pre">find_element_by_link_text()</span></code>, which was used in the original <a class="reference external" href="https://github.com/Kat-Alo/deed-scraper/blob/0.0.0original/processors/main-scraper.py#L105">main-scraper.py</a>.</p>
<p>I won’t pretend that my example of <code class="docutils literal notranslate"><span class="pre">xpath()</span></code> is nicer then the convenience of <code class="docutils literal notranslate"><span class="pre">find_element_by_link_text()</span></code> – it’s mostly meant as an example of how the XPath syntax can be used to very explicitly and specifically target an element. Why would you ever need to do this? What if the HTML results were to include more than one link with the text, <code class="docutils literal notranslate"><span class="pre">'Last'</span></code>? Or even worse, the site switches up its HTML, so that the <code class="docutils literal notranslate"><span class="pre">'Last'</span></code> link no longer is part of the search results table element? My <code class="docutils literal notranslate"><span class="pre">xpath()</span></code> example would immediately fail, in a very obvious way, whereas <code class="docutils literal notranslate"><span class="pre">find_element_by_link_text()</span></code> would “silently” fail.</p>
<p>Also, the <code class="docutils literal notranslate"><span class="pre">xpath()</span></code> instance function is much easier to test in isolation because it only requires creating a lxml HTML element – as opposed to instantiating a selenium browser instance.</p>
<p>As you do more web-scraping and HTML parsing, I think you’ll eventually appreciate the advantages and need to writing out more explicit CSS/XPath selectors. But there’s no denying it’s a pain in the ass early on!</p>
</div>
</div>
<div class="section" id="don-t-repeat-yourself-dry">
<h2><a class="toc-backref" href="#id12">Don’t repeat yourself (DRY)</a><a class="headerlink" href="#don-t-repeat-yourself-dry" title="Permalink to this headline">¶</a></h2>
<p>If you see 4 or more lines of code that look almost exactly the same, and do exactly the same thing on different variables, then it’s a good sign you might be able to reduce and abstract it to a pattern.</p>
<div class="section" id="drying-up-the-text-cleaning-work">
<h3><a class="toc-backref" href="#id13">DRYing up the text-cleaning work</a><a class="headerlink" href="#drying-up-the-text-cleaning-work" title="Permalink to this headline">¶</a></h3>
<p>For example, in <a class="reference internal" href="#script-results-parser-py"><span class="std std-ref">results_parser.py</span></a>, several of your <code class="docutils literal notranslate"><span class="pre">get_</span></code> methods apply a cleaning/normalizing step to the text – i.e. stripping of leading/trailing whitespace:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_muni</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Muni:)(.*)(?=Address:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

<span class="hll">    <span class="n">muni</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span>    <span class="n">muni</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">muni</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">muni</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_rec_date</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Rec Date: )(.*)(?=L:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

<span class="hll">    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></pre></div>
</div>
<p>And there are a couple times in which you extract text, but don’t apply <code class="docutils literal notranslate"><span class="pre">strip()</span></code>:</p>
<p>Do you really know for sure that all “doc_number” and “doc_type” values don’t have extraneous whitespace? In any case, better to be safe than sorry, and just run <code class="docutils literal notranslate"><span class="pre">strip()</span></code> anyway.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_doc_number</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">row_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_doc_type</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">row_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Instead of applying this cleaning step inside each <code class="docutils literal notranslate"><span class="pre">get_()</span></code> extraction function, create a helper function that encapsulates the work:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_tfix</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">txt</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>I like prefixing such small helper functions with an <strong>underscore</strong> to help remind myself, at a glance, that these functions were designed to be used internally by the current script, and aren’t really meant to be used standalone.</p>
<p class="last">If we were writing this app in an object-oriented programming style, we would define a function like <cite>_tfix()</cite> as being <code class="docutils literal notranslate"><span class="pre">private</span></code> or <code class="docutils literal notranslate"><span class="pre">protected</span></code>, which not only serves as a reminder to its limited scope, but also makes it very hard to casually use it outside of the results-parsing script.</p>
</div>
<p>It might seem like overkill to define a new function, <code class="docutils literal notranslate"><span class="pre">_tfix()</span></code>, given how simple its functionality. But later ony you might realize that more cleaning steps are needed, such as removing consecutive whitespace <em>in between</em> words, or maybe upcasing the text. Now you only have to add these steps to the definition of <code class="docutils literal notranslate"><span class="pre">_tfix()</span></code>, rather than replacing all the instances you wrote  <code class="docutils literal notranslate"><span class="pre">.strip()</span></code>.</p>
<p>Now, instead of trying to clean the string <em>inside the extraction function</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_rec_date</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Rec Date: )(.*)(?=L:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

<span class="hll">    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span>
<span class="c1"># ...</span>

<span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">rec_date</span> <span class="o">=</span> <span class="n">get_rec_date</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec_date</span><span class="p">)</span>
</pre></div>
</div>
<p>Instead, use <code class="docutils literal notranslate"><span class="pre">_tfix()</span></code> on the extraction function’s <em>return value</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_rec_date</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Rec Date: )(.*)(?=L:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># ...</span>

<span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">rec_date</span> <span class="o">=</span> <span class="n">get_rec_date</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="c1"># ...</span>
<span class="hll">    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tfix</span><span class="p">(</span><span class="n">rec_date</span><span class="p">))</span>
</span></pre></div>
</div>
<p>Because each of the extraction functions return text, we can call <code class="docutils literal notranslate"><span class="pre">_tfix()</span></code> on all of them without worry:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tfix</span><span class="p">(</span><span class="n">doc_type</span><span class="p">))</span>
<span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tfix</span><span class="p">(</span><span class="n">doc_number</span><span class="p">))</span>
<span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tfix</span><span class="p">(</span><span class="n">rec_date</span><span class="p">))</span>
<span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tfix</span><span class="p">(</span><span class="n">grantor</span><span class="p">))</span>
<span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tfix</span><span class="p">(</span><span class="n">grantee</span><span class="p">))</span>
<span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tfix</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
<span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tfix</span><span class="p">(</span><span class="n">muni</span><span class="p">))</span>
</pre></div>
</div>
<p>We can continue DRYing our code by eliminating the repetitive calls of <code class="docutils literal notranslate"><span class="pre">clean_row.append(_tfix())</span></code>. Here’s one way to do it, for now:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc_type</span><span class="p">,</span> <span class="n">doc_number</span><span class="p">,</span> <span class="n">rec_date</span><span class="p">,</span> <span class="n">grantor</span><span class="p">,</span>
         <span class="n">grantee</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">muni</span><span class="p">,]</span>

<span class="n">clean_row</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tfix</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</pre></div>
</div>
<p>Or, better yet, practice the Pythonic style by using a list comprehension:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc_type</span><span class="p">,</span> <span class="n">doc_number</span><span class="p">,</span> <span class="n">rec_date</span><span class="p">,</span> <span class="n">grantor</span><span class="p">,</span>
         <span class="n">grantee</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">muni</span><span class="p">,]</span>
<span class="n">clean_row</span> <span class="o">=</span> <span class="p">[</span><span class="n">_tfix</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="drying-up-the-html-parsing-text-extraction">
<h3><a class="toc-backref" href="#id14">DRYing up the HTML parsing/text-extraction</a><a class="headerlink" href="#drying-up-the-html-parsing-text-extraction" title="Permalink to this headline">¶</a></h3>
<p>The Wayne County RoD site has a wonky way of presenting search results. Each <code class="docutils literal notranslate"><span class="pre">&lt;tr&gt;</span></code> result row has 2 <code class="docutils literal notranslate"><span class="pre">&lt;td&gt;</span></code> cells containing data.</p>
<p>The first <code class="docutils literal notranslate"><span class="pre">&lt;td&gt;</span></code> is straightforward, and contains, as text elements, the <strong>document type</strong> and <strong>number</strong> separated by a <code class="docutils literal notranslate"><span class="pre">&lt;br&gt;</span></code> (effectively a <code class="docutils literal notranslate"><span class="pre">\n</span></code> character):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">tr</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;even&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">td</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span>
<span class="hll">            <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;../eagleweb/viewDoc.jsp?node=DOCCL-20093323&quot;</span><span class="o">&gt;</span><span class="n">WARRANTY</span> <span class="n">DEED</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span>
</span><span class="hll">            <span class="mi">201020860</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</span>        <span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">td</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;../eagleweb/viewDoc.jsp?node=DOCCL-20093323&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">table</span> <span class="n">border</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">cellspacing</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="o">&gt;&lt;</span><span class="n">tbody</span><span class="o">&gt;&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">nowrap</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Rec</span> <span class="n">Date</span><span class="p">:</span> <span class="mi">12</span><span class="o">/</span><span class="mi">27</span><span class="o">/</span><span class="mi">2000</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">L</span><span class="p">:</span> <span class="mi">33007</span> <span class="n">P</span><span class="p">:</span> <span class="mi">637</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;50%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Grantor</span><span class="p">:</span> <span class="n">COMMERCE</span> <span class="n">CONSTRUCTION</span> <span class="n">CO</span> <span class="n">INC</span> <span class="p">,</span> <span class="n">FOUNTAIN</span> <span class="n">HOMES</span>  <span class="n">DBA</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;50%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Grantee</span><span class="p">:</span> <span class="n">NGUYEN</span> <span class="n">MINH</span> <span class="n">D</span>     <span class="n">MARRIED</span><span class="p">,</span> <span class="n">NGUYEN</span> <span class="n">RACHAEL</span> <span class="n">E</span> <span class="n">HW</span>     <span class="n">MARRIED</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;&lt;/</span><span class="n">tbody</span><span class="o">&gt;&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">table</span> <span class="n">border</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">cellspacing</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="o">&gt;&lt;</span><span class="n">tbody</span><span class="o">&gt;&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;20%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Muni</span><span class="p">:</span> <span class="n">BROWNSTOWN</span> <span class="n">TOWNSHIP</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;20%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Address</span><span class="p">:</span> <span class="mi">23596</span> <span class="n">STACEY</span> <span class="n">DR</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;20%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span> <span class="n">Tax</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">70065040291000</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;40%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span>    <span class="n">Subd</span><span class="p">:</span> <span class="n">FLOWERS</span> <span class="n">CREEK</span> <span class="n">NO</span> <span class="mi">3</span>   <span class="n">Liber</span><span class="p">:</span> <span class="mi">114</span>   <span class="n">Page</span><span class="p">:</span> <span class="mi">54</span>    <span class="n">Lot</span><span class="p">:</span> <span class="mi">291</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;&lt;/</span><span class="n">tbody</span><span class="o">&gt;&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">td</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">td</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The other data points, such as <strong>muni</strong> and <strong>rec_address</strong>, are contained in the second <code class="docutils literal notranslate"><span class="pre">&lt;td&gt;</span></code>, which itself contains two tables, with their own <code class="docutils literal notranslate"><span class="pre">&lt;td&gt;</span></code> elements:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>            <span class="o">&lt;</span><span class="n">table</span> <span class="n">border</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">cellspacing</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="o">&gt;&lt;</span><span class="n">tbody</span><span class="o">&gt;&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
<span class="hll">                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;20%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Muni</span><span class="p">:</span> <span class="n">BROWNSTOWN</span> <span class="n">TOWNSHIP</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
</span><span class="hll">                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;20%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Address</span><span class="p">:</span> <span class="mi">23596</span> <span class="n">STACEY</span> <span class="n">DR</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
</span>                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;20%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span> <span class="n">Tax</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">70065040291000</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;40%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span>    <span class="n">Subd</span><span class="p">:</span> <span class="n">FLOWERS</span> <span class="n">CREEK</span> <span class="n">NO</span> <span class="mi">3</span>   <span class="n">Liber</span><span class="p">:</span> <span class="mi">114</span>   <span class="n">Page</span><span class="p">:</span> <span class="mi">54</span>    <span class="n">Lot</span><span class="p">:</span> <span class="mi">291</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This makes writing the extraction functions a pain in the ass, as you likely saw when, in <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code>, when you extracted (as text) the two <code class="docutils literal notranslate"><span class="pre">&lt;td&gt;</span></code> elements from <code class="docutils literal notranslate"><span class="pre">row</span></code>, which you then split up (again as text) and then fed into their corresponding data point extraction methods, e.g. <code class="docutils literal notranslate"><span class="pre">sec_col_sec_row</span></code> into <code class="docutils literal notranslate"><span class="pre">get_address()</span></code>:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">clean_row</span> <span class="o">=</span> <span class="p">[]</span>

<span class="hll">    <span class="n">first_col_text</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
</span>
    <span class="n">doc_type</span> <span class="o">=</span> <span class="n">get_doc_type</span><span class="p">(</span><span class="n">first_col_text</span><span class="p">)</span>
    <span class="n">doc_number</span> <span class="o">=</span> <span class="n">get_doc_number</span><span class="p">(</span><span class="n">first_col_text</span><span class="p">)</span>

<span class="hll">    <span class="n">second_col_text</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;td:nth-of-type(2)&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
</span><span class="hll">    <span class="n">sec_col_first_row</span> <span class="o">=</span> <span class="n">second_col_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="hll">    <span class="n">sec_col_sec_row</span> <span class="o">=</span> <span class="n">second_col_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</span>
    <span class="n">rec_date</span> <span class="o">=</span> <span class="n">get_rec_date</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="n">grantor</span> <span class="o">=</span> <span class="n">get_grantor</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="n">grantee</span> <span class="o">=</span> <span class="n">get_grantee</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
<span class="hll">    <span class="n">address</span> <span class="o">=</span> <span class="n">get_address</span><span class="p">(</span><span class="n">sec_col_sec_row</span><span class="p">)</span>
</span>    <span class="n">muni</span> <span class="o">=</span> <span class="n">get_muni</span><span class="p">(</span><span class="n">sec_col_sec_row</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>The other approach would be to leave the <code class="docutils literal notranslate"><span class="pre">row</span></code> variable – i.e. the contents of <a class="reference internal" href="#example-results-row-html"><span class="std std-ref">example-results-row.html</span></a> – as is, and have each of the data extraction functions operate on it. That’s very cumbersome if you treat <code class="docutils literal notranslate"><span class="pre">row</span></code> as text, because it would require you to repeat that text-splitting/partitioning work in each of the extraction functions. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_address</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="hll">    <span class="n">_x</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;td:nth-of-type(2)&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
</span><span class="hll">    <span class="n">row_text</span> <span class="o">=</span> <span class="n">_x</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</span>    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Address:)(.*)(?=Tax ID:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="n">address</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">address</span>

<span class="k">def</span> <span class="nf">get_muni</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="hll">    <span class="n">_x</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;td:nth-of-type(2)&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
</span><span class="hll">    <span class="n">row_text</span> <span class="o">=</span> <span class="n">_x</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</span>    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Muni:)(.*)(?=Address:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="n">muni</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">muni</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">muni</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">muni</span>
</pre></div>
</div>
<p><em>However</em>, if the data extraction functions accept as parameter the entirety of <code class="docutils literal notranslate"><span class="pre">row</span></code>, but as a <em>parsed HTML element</em> – i.e. <code class="docutils literal notranslate"><span class="pre">lxml.HtmlElement</span></code> – rather than raw text, they become much simpler:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lxml.html</span> <span class="kn">import</span> <span class="n">fromstring</span> <span class="k">as</span> <span class="n">hparse</span>
<span class="n">_DATA_SEL</span> <span class="o">=</span> <span class="s1">&#39;tr &gt; td:nth-child(2) table td&#39;</span>

<span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">el</span> <span class="o">=</span> <span class="n">hparse</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="c1"># ...</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">get_address</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
    <span class="n">muni</span> <span class="o">=</span> <span class="n">get_muni</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_address</span><span class="p">(</span><span class="n">el</span><span class="p">):</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="n">_DATA_SEL</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Address: *(.+)&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">addr</span>

<span class="k">def</span> <span class="nf">get_muni</span><span class="p">(</span><span class="n">el</span><span class="p">):</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="n">_DATA_SEL</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
    <span class="n">muni</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Muni: *(.+)&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">muni</span>
</pre></div>
</div>
</div>
<div class="section" id="wrapping-it-up-into-a-loopable-sequence">
<h3><a class="toc-backref" href="#id15">Wrapping it up into a loopable sequence</a><a class="headerlink" href="#wrapping-it-up-into-a-loopable-sequence" title="Permalink to this headline">¶</a></h3>
<p>The purpose of our work is to take all of these similarly-purposed data extraction functions and force them to become as uniform as possible – which, for the most part, can be done by designing them to expect the same argument, and to return the same type of value.</p>
<p>Once this is done, each of these functions can, for all intents and purposes, be treated as homogenous elements in a list. Which means they can be looped across easily.</p>
<p>Thus, if <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code> started like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">clean_row</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">first_col_text</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>

    <span class="n">doc_type</span> <span class="o">=</span> <span class="n">get_doc_type</span><span class="p">(</span><span class="n">first_col_text</span><span class="p">)</span>
    <span class="n">doc_number</span> <span class="o">=</span> <span class="n">get_doc_number</span><span class="p">(</span><span class="n">first_col_text</span><span class="p">)</span>

    <span class="n">second_col_text</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;td:nth-of-type(2)&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
    <span class="n">sec_col_first_row</span> <span class="o">=</span> <span class="n">second_col_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sec_col_sec_row</span> <span class="o">=</span> <span class="n">second_col_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">rec_date</span> <span class="o">=</span> <span class="n">get_rec_date</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="n">grantor</span> <span class="o">=</span> <span class="n">get_grantor</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="n">grantee</span> <span class="o">=</span> <span class="n">get_grantee</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">get_address</span><span class="p">(</span><span class="n">sec_col_sec_row</span><span class="p">)</span>
    <span class="n">muni</span> <span class="o">=</span> <span class="n">get_muni</span><span class="p">(</span><span class="n">sec_col_sec_row</span><span class="p">)</span>


    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc_type</span><span class="p">,</span> <span class="n">doc_number</span><span class="p">,</span> <span class="n">rec_date</span><span class="p">,</span>
            <span class="n">grantor</span><span class="p">,</span> <span class="n">grantee</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">muni</span><span class="p">,]</span>
    <span class="n">clean_row</span> <span class="o">=</span> <span class="p">[</span><span class="n">_tfix</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">clean_row</span>
</pre></div>
</div>
<p id="parse-row-can-be-simplified"><code class="docutils literal notranslate"><span class="pre">parse_row()</span></code> can now be simplified to this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ATTR_FOOS</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_doc_type</span><span class="p">,</span> <span class="n">get_doc_number</span><span class="p">,</span> <span class="n">get_rec_date</span><span class="p">,</span> <span class="n">get_grantor</span><span class="p">,</span>
             <span class="n">get_grantee</span><span class="p">,</span> <span class="n">get_address</span><span class="p">,</span> <span class="n">get_muni</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ATTR_FOOS</span><span class="p">]</span>
    <span class="n">clean_row</span> <span class="o">=</span> <span class="p">[</span><span class="n">_tfix</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">clean_row</span>
</pre></div>
</div>
<p>Or even just:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ATTR_FOOS</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_doc_type</span><span class="p">,</span> <span class="n">get_doc_number</span><span class="p">,</span> <span class="n">get_rec_date</span><span class="p">,</span> <span class="n">get_grantor</span><span class="p">,</span>
             <span class="n">get_grantee</span><span class="p">,</span> <span class="n">get_address</span><span class="p">,</span> <span class="n">get_muni</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">_tfix</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ATTR_FOOS</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="mapping-fieldnames-to-their-respective-extraction-functions-with-a-dict">
<span id="ref-mapping-fieldnames"></span><h3><a class="toc-backref" href="#id16">Mapping fieldnames to their respective extraction functions with a dict</a><a class="headerlink" href="#mapping-fieldnames-to-their-respective-extraction-functions-with-a-dict" title="Permalink to this headline">¶</a></h3>
<p>One of the most annoying parts of a hacked-together data wrangling project is figuring out where to do the mundane work of defining the <em>schema</em>, and how to tie it to the data converting/exporting parts of the code, and how to do it consistently. In a more mature project, with multiple data types and formats, you’d probably define it in external configuration files (such as JSON or XML), and even design an object-oriented system (e.g. defining a <strong>class</strong> like “DeedRecord”).</p>
<p>But that’s <em>usually</em> too formal and unnecessary for this kind of project. What you did in <a class="reference internal" href="#script-results-parser-py"><span class="std std-ref">results_parser.py</span></a> is a pretty good approach. For example, defining the headers as a constant, <code class="docutils literal notranslate"><span class="pre">CSV_HEADERS</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CSV_HEADERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;document_type&#39;</span><span class="p">,</span> <span class="s1">&#39;document_number&#39;</span><span class="p">,</span> <span class="s1">&#39;rec_date&#39;</span><span class="p">,</span> <span class="s1">&#39;grantor&#39;</span><span class="p">,</span> <span class="s1">&#39;grantee&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;muni&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>As it turns out, as the scraping app stands now – even after my overhaul – there’s no reason for the codebase (<em>outside of the HTML-parsing/CSV-creating</em>) to care about the CSV layout. So having it as a constant in the parsing script is fine.</p>
<p>And when you do need to refer to it – as I do in some of the test scripts (e.g. <a class="reference external" href="https://github.com/Kat-Alo/deed-scraper/blob/0.2.0/tests/search_results_parser/test_parse.py">tests/search_results_parser/test_parse.py</a> ) – you can always refer to it via an <code class="docutils literal notranslate"><span class="pre">import</span></code> statement, e.g.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">processors.results_parser</span> <span class="kn">import</span> <span class="n">CSV_HEADERS</span>
</pre></div>
</div>
<p>However, one issue you seem to have run into with <a class="reference internal" href="#script-results-parser-py"><span class="std std-ref">results_parser.py</span></a> was the awkwardness of sharing that layout knowledge with the two functions, <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code> and <code class="docutils literal notranslate"><span class="pre">html_to_csv()</span></code>.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code>, the individual data points are carefully appended to the <code class="docutils literal notranslate"><span class="pre">clean_row</span></code> return value, in the same order as the corresponding headers. Again, since this is a relatively small (in scope) data project, this seems easy enough to manage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">clean_row</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># ...</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc_type</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc_number</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec_date</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grantor</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grantee</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">muni</span><span class="p">)</span>

    <span class="c1"># ...</span>
    <span class="k">return</span> <span class="n">clean_row</span>
</pre></div>
</div>
<p>However, this can be a frequent source of bugs as you decide to change the layout – whether you’re rearranging the order of field names in <code class="docutils literal notranslate"><span class="pre">CSV_HEADERS</span></code>, or you’re adding/removing fields. Again, it’s a relatively minor thing for your current usecase – e.g. because your end user is someone looking at the data in Excel. But having this somewhat flaky code can hinder you from thinking about making a better data pipeline, or even just making quick changes to it.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">html_to_csv()</span></code>, you’ve largely bypassed the issue of making sure <code class="docutils literal notranslate"><span class="pre">CSV_HEADERS</span></code> is synced with the data layout, because it calls <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code>, and thus just doesn’t need to know the order of the fieldnames or the data, letting <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code> handle that. One consequence is that you have to use <code class="docutils literal notranslate"><span class="pre">csv.writer</span></code>, as opposed to <code class="docutils literal notranslate"><span class="pre">csv.DictWriter</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">html_to_csv</span><span class="p">(</span><span class="n">name_hyphenated</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">csv_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">CSV_HEADERS</span><span class="p">]</span>

    <span class="c1"># ...</span>
      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;odd&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;even&#39;</span><span class="p">]:</span>
              <span class="n">clean_row</span> <span class="o">=</span> <span class="n">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
              <span class="n">csv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_row</span><span class="p">)</span>

    <span class="c1"># ...</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_list</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<p>Nothing wrong with using <code class="docutils literal notranslate"><span class="pre">csv.writer</span></code>, but I prefer using <code class="docutils literal notranslate"><span class="pre">csv.DictWriter</span></code> whenever possible because it allows us to be explicit in saying that we’re writing the rows based on an actual schema, rather than just simple appending-via-list.</p>
<p>So how do we sync our list of fieldnames (<code class="docutils literal notranslate"><span class="pre">CSV_HEADERS</span></code>) with the rest of the code? By making <code class="docutils literal notranslate"><span class="pre">CSV_HEADERS</span></code> a <code class="docutils literal notranslate"><span class="pre">dict</span></code>, with each <strong>key</strong> being a fieldname string, and each corresponding <strong>value</strong> being the <em>function</em> that extracts the data for that particular fieldname:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CSV_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;document_type&#39;</span><span class="p">:</span> <span class="n">get_document_type</span>
  <span class="s1">&#39;document_number&#39;</span><span class="p">:</span> <span class="n">get_document_number</span><span class="p">,</span>
  <span class="s1">&#39;rec_date&#39;</span><span class="p">:</span> <span class="n">get_rec_date</span><span class="p">,</span>
  <span class="s1">&#39;grantor&#39;</span><span class="p">:</span> <span class="n">get_grantor</span><span class="p">,</span>
  <span class="s1">&#39;grantee&#39;</span><span class="p">:</span> <span class="n">get_grantee</span><span class="p">,</span>
  <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="n">get_address</span><span class="p">,</span>
  <span class="s1">&#39;muni&#39;</span><span class="p">:</span> <span class="n">get_muni</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Recall how <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code> was <a class="reference internal" href="#parse-row-can-be-simplified"><span class="std std-ref">simplified in the previous section</span></a>, by creating a new list of function references, in the order that we want the extracted data fields to come out as (e.g. mimicking the schema defined in <code class="docutils literal notranslate"><span class="pre">CSV_HEADERS</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ATTR_FOOS</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_doc_type</span><span class="p">,</span> <span class="n">get_doc_number</span><span class="p">,</span> <span class="n">get_rec_date</span><span class="p">,</span> <span class="n">get_grantor</span><span class="p">,</span>
             <span class="n">get_grantee</span><span class="p">,</span> <span class="n">get_address</span><span class="p">,</span> <span class="n">get_muni</span><span class="p">]</span>

<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">_tfix</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ATTR_FOOS</span><span class="p">]</span>
</pre></div>
</div>
<p>By defining <code class="docutils literal notranslate"><span class="pre">CSV_HEADERS</span></code> as a <code class="docutils literal notranslate"><span class="pre">dict</span></code>, we are able to tie the fieldnames to the functions, i.e. there is no longer a need to maintain a separate list of data extraction functions <code class="docutils literal notranslate"><span class="pre">ATTR_FOOS</span></code>. Which means, we don’t have to worry about the data layout and functionality being out of sync.</p>
<p>Also, <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code> can now return a <strong>dict</strong> – containing extracted data values associated with their respective headers – as opposed to just a sequential list of extracted data values:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CSV_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;document_type&#39;</span><span class="p">:</span> <span class="n">get_document_type</span>
  <span class="s1">&#39;document_number&#39;</span><span class="p">:</span> <span class="n">get_document_number</span><span class="p">,</span>
  <span class="s1">&#39;rec_date&#39;</span><span class="p">:</span> <span class="n">get_rec_date</span><span class="p">,</span>
  <span class="s1">&#39;grantor&#39;</span><span class="p">:</span> <span class="n">get_grantor</span><span class="p">,</span>
  <span class="s1">&#39;grantee&#39;</span><span class="p">:</span> <span class="n">get_grantee</span><span class="p">,</span>
  <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="n">get_address</span><span class="p">,</span>
  <span class="s1">&#39;muni&#39;</span><span class="p">:</span> <span class="n">get_muni</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">foo</span> <span class="ow">in</span> <span class="n">CSV_HEADERS</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tfix</span><span class="p">(</span><span class="n">foo</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>Or, if you like using <a class="reference external" href="https://www.python.org/dev/peps/pep-0274/">dict comprehensions</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span> <span class="n">h</span><span class="p">:</span> <span class="n">_tfix</span><span class="p">(</span><span class="n">foo</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">foo</span> <span class="ow">in</span> <span class="n">CSV_HEADERS</span> <span class="p">}</span>
</pre></div>
</div>
<div class="section" id="why-care-about-using-csv-dictwriter">
<h4><a class="toc-backref" href="#id17">Why care about using csv.DictWriter</a><a class="headerlink" href="#why-care-about-using-csv-dictwriter" title="Permalink to this headline">¶</a></h4>
<p>With <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code> returning a dict, the changes to <code class="docutils literal notranslate"><span class="pre">html_to_csv()</span></code> would be relatively minor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">html_to_csv</span><span class="p">(</span><span class="n">name_hyphenated</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="c1"># don&#39;t need this anymore:</span>
    <span class="c1"># csv_list = [CSV_HEADERS]</span>

    <span class="c1"># ...</span>
    <span class="c1"># this remains the same:</span>
      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;odd&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;even&#39;</span><span class="p">]:</span>
              <span class="n">clean_row</span> <span class="o">=</span> <span class="n">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
              <span class="n">csv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_row</span><span class="p">)</span>

    <span class="c1"># ...</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">CSV_HEADERS</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_list</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<p>At a glance, there’s really not much functional difference between using <code class="docutils literal notranslate"><span class="pre">csv.writer</span></code> and <code class="docutils literal notranslate"><span class="pre">csv.DictWriter</span></code>. However, what I like about the latter is that it acts as a kind of <em>guarantee</em>: that the rows returned by <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code> have the exact data fieldnames as enumerated and ordered in <code class="docutils literal notranslate"><span class="pre">CSV_HEADERS</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Because we made <code class="docutils literal notranslate"><span class="pre">CSV_HEADERS</span></code> itself a dict, in which each fieldname is tied to its respective function, it’s now basically impossible to add/change a fieldname without making the appropriate change to the data extraction work. But pretend we didn’t for the sake of the hypothetical in this next paragraph…</p>
</div>
<p>Pretend that at some later point in development, you make a change to the ordering of the fieldnames. And maybe in <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code> you add a new data field to be extracted. Or maybe you remove one. In any case, <code class="docutils literal notranslate"><span class="pre">csv.writer</span></code> will happily without error export the misaligned fieldnames and fields. Whereas <code class="docutils literal notranslate"><span class="pre">csv.DictWriter</span></code> will immediately break for any number of reasons, including when the dict, as returned by <code class="docutils literal notranslate"><span class="pre">parse_row()</span></code>:</p>
<ul class="simple">
<li>doesn’t have the exact number of keys as <code class="docutils literal notranslate"><span class="pre">CSV_HEADERS</span></code> has fieldnames (i.e. what’s passed into <code class="docutils literal notranslate"><span class="pre">csv.DictWriter's</span></code> <code class="docutils literal notranslate"><span class="pre">fieldnames</span></code> parameter)</li>
<li>doesn’t have keys exactly named as the fieldnames in <code class="docutils literal notranslate"><span class="pre">CSV_HEADERS</span></code></li>
</ul>
<p>Failing early and loudly is most definitely what you want to happen in this data wrangling/exporting situation.</p>
</div>
</div>
</div>
<div class="section" id="code-references">
<h2><a class="toc-backref" href="#id18">Code references</a><a class="headerlink" href="#code-references" title="Permalink to this headline">¶</a></h2>
<div class="section" id="results-parser-py">
<span id="script-results-parser-py"></span><h3><a class="toc-backref" href="#id19">results_parser.py</a><a class="headerlink" href="#results-parser-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">bs4</span> <span class="k">import</span> <span class="n">BeautifulSoup</span>

<span class="n">CSV_HEADERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;document_type&#39;</span><span class="p">,</span> <span class="s1">&#39;document_number&#39;</span><span class="p">,</span> <span class="s1">&#39;rec_date&#39;</span><span class="p">,</span> <span class="s1">&#39;grantor&#39;</span><span class="p">,</span> <span class="s1">&#39;grantee&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;muni&#39;</span><span class="p">]</span>
<span class="n">RAW_DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;data/raw-html/&quot;</span>
<span class="n">PROCESSED_DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;data/processed-csv/&quot;</span>
<span class="n">ERROR_MESSAGE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NO HTML FILES AVAILABLE TO PARSE, CHECK OR REFINE SEARCH PARAMETERS.&quot;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_muni</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Muni:)(.*)(?=Address:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="n">muni</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">muni</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">muni</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">muni</span>

<span class="k">def</span> <span class="nf">get_address</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Address:)(.*)(?=Tax ID:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="n">address</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">address</span>

<span class="k">def</span> <span class="nf">get_grantee</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Grantee: )(.*)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="n">grantee</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">grantee</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">grantee</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grantee</span>

<span class="k">def</span> <span class="nf">get_grantor</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Grantor: )(.*)(?=Grantee:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="n">grantor</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">grantor</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">grantor</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grantor</span>

<span class="k">def</span> <span class="nf">get_rec_date</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(?&lt;=Rec Date: )(.*)(?=L:)&#39;</span><span class="p">,</span> <span class="n">row_text</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_doc_number</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">row_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_doc_type</span><span class="p">(</span><span class="n">row_text</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">row_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">clean_row</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">first_col_text</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>

    <span class="n">doc_type</span> <span class="o">=</span> <span class="n">get_doc_type</span><span class="p">(</span><span class="n">first_col_text</span><span class="p">)</span>
    <span class="n">doc_number</span> <span class="o">=</span> <span class="n">get_doc_number</span><span class="p">(</span><span class="n">first_col_text</span><span class="p">)</span>

    <span class="n">second_col_text</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;td:nth-of-type(2)&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
    <span class="n">sec_col_first_row</span> <span class="o">=</span> <span class="n">second_col_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sec_col_sec_row</span> <span class="o">=</span> <span class="n">second_col_text</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">rec_date</span> <span class="o">=</span> <span class="n">get_rec_date</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="n">grantor</span> <span class="o">=</span> <span class="n">get_grantor</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="n">grantee</span> <span class="o">=</span> <span class="n">get_grantee</span><span class="p">(</span><span class="n">sec_col_first_row</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">get_address</span><span class="p">(</span><span class="n">sec_col_sec_row</span><span class="p">)</span>
    <span class="n">muni</span> <span class="o">=</span> <span class="n">get_muni</span><span class="p">(</span><span class="n">sec_col_sec_row</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;doc type is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">doc_type</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;doc number is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">doc_number</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rec date is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rec_date</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;grantor is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">grantor</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;grantee is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">grantee</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;address is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">address</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;muni is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">muni</span><span class="p">)</span>

    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc_type</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc_number</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec_date</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grantor</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grantee</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="n">clean_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">muni</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-----------------------------------&quot;</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">clean_row</span>

<span class="k">def</span> <span class="nf">html_to_csv</span><span class="p">(</span><span class="n">name_hyphenated</span><span class="p">):</span>

    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">RAW_DATA_DIR</span> <span class="o">+</span> <span class="n">name_hyphenated</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;.html&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="n">csv_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">CSV_HEADERS</span><span class="p">]</span>

    <span class="c1">#if there aren&#39;t any filenames, handle it</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">csv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ERROR_MESSAGE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="n">file</span>

            <span class="n">file_to_soupify</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">file_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">file_to_soupify</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">file_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;searchResultsTable&quot;</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;odd&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;even&#39;</span><span class="p">]:</span>
                    <span class="n">clean_row</span> <span class="o">=</span> <span class="n">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">csv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_row</span><span class="p">)</span>

    <span class="n">csv_filename</span> <span class="o">=</span> <span class="n">PROCESSED_DATA_DIR</span> <span class="o">+</span> <span class="n">name_hyphenated</span> <span class="o">+</span> <span class="s1">&#39;-rod-results.csv&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_list</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">html_to_csv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>









</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="search-results-parser-py">
<span id="script-search-results-parser-py"></span><h3><a class="toc-backref" href="#id20">search_results_parser.py</a><a class="headerlink" href="#search-results-parser-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">config</span> <span class="k">import</span> <span class="n">BASE_ENDPOINT</span><span class="p">,</span> <span class="n">hparse</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="k">import</span> <span class="n">urljoin</span>

<span class="n">_DATA_SEL</span> <span class="o">=</span> <span class="s1">&#39;tr &gt; td:nth-child(2) table td&#39;</span>


<span class="k">def</span> <span class="nf">_extract_grantor</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="n">_DATA_SEL</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^Grantor: *(.+)&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s{3,}&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_extract_grantee</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="n">_DATA_SEL</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^Grantee: *(.+)&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s{3,}&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_extract_rec_date</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">rectxt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="n">_DATA_SEL</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^Rec Date: *(\d</span><span class="si">{2}</span><span class="s1">)/(\d</span><span class="si">{2}</span><span class="s1">)/(\d</span><span class="si">{4}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">rectxt</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_extract_record_url</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
  <span class="n">href</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;./td[1]/strong/a[1]/@href&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">BASE_ENDPOINT</span><span class="p">,</span> <span class="n">href</span><span class="p">)</span>


<span class="n">RESULT_FIELDS</span> <span class="o">=</span>  <span class="p">{</span>
  <span class="s1">&#39;document_type&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="s1">&#39;td strong a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;document_number&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="s1">&#39;td strong a&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
  <span class="s1">&#39;rec_date&#39;</span><span class="p">:</span> <span class="n">_extract_rec_date</span><span class="p">,</span>
  <span class="s1">&#39;grantor&#39;</span><span class="p">:</span> <span class="n">_extract_grantor</span><span class="p">,</span>
  <span class="s1">&#39;grantee&#39;</span><span class="p">:</span> <span class="n">_extract_grantee</span><span class="p">,</span>
  <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Address: *(.+)&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="n">_DATA_SEL</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">())</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;muni&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Muni: *(.+)&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="n">_DATA_SEL</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">text_content</span><span class="p">())</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
  <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">_extract_record_url</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">SEARCH_RESULT_HEADERS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">RESULT_FIELDS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">extract_field</span><span class="p">(</span><span class="n">fieldname</span><span class="p">,</span> <span class="n">el</span><span class="p">):</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">RESULT_FIELDS</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">el</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">txt</span>


<span class="k">def</span> <span class="nf">parse_result</span><span class="p">(</span><span class="n">el</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">fn</span><span class="p">:</span> <span class="n">extract_field</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">SEARCH_RESULT_HEADERS</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">parse_rows</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    txt: a string, presumably of HTML</span>

<span class="sd">    returns: a list of lxml.html.HtmlElement</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">hparse</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">cssselect</span><span class="p">(</span><span class="s1">&#39;tr.odd, tr.even&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rows</span>


<span class="k">def</span> <span class="nf">parse_records_on_page</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    txt: a string, presumably of a full HTML page</span>

<span class="sd">    returns: list of dicts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_result</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">parse_rows</span><span class="p">(</span><span class="n">txt</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">records</span>


<span class="c1"># alias parse_records_on_page</span>
<span class="n">parse</span> <span class="o">=</span> <span class="n">parse_records_on_page</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="example-results-row-html">
<span id="id1"></span><h3><a class="toc-backref" href="#id21">example-results-row.html</a><a class="headerlink" href="#example-results-row-html" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">tr</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;even&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">td</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;../eagleweb/viewDoc.jsp?node=DOCCL-20093323&quot;</span><span class="o">&gt;</span><span class="n">WARRANTY</span> <span class="n">DEED</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span>
            <span class="mi">201020860</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">strong</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">td</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;../eagleweb/viewDoc.jsp?node=DOCCL-20093323&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">table</span> <span class="n">border</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">cellspacing</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="o">&gt;&lt;</span><span class="n">tbody</span><span class="o">&gt;&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">nowrap</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Rec</span> <span class="n">Date</span><span class="p">:</span> <span class="mi">12</span><span class="o">/</span><span class="mi">27</span><span class="o">/</span><span class="mi">2000</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">L</span><span class="p">:</span> <span class="mi">33007</span> <span class="n">P</span><span class="p">:</span> <span class="mi">637</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;50%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Grantor</span><span class="p">:</span> <span class="n">COMMERCE</span> <span class="n">CONSTRUCTION</span> <span class="n">CO</span> <span class="n">INC</span> <span class="p">,</span> <span class="n">FOUNTAIN</span> <span class="n">HOMES</span>  <span class="n">DBA</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;50%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Grantee</span><span class="p">:</span> <span class="n">NGUYEN</span> <span class="n">MINH</span> <span class="n">D</span>     <span class="n">MARRIED</span><span class="p">,</span> <span class="n">NGUYEN</span> <span class="n">RACHAEL</span> <span class="n">E</span> <span class="n">HW</span>     <span class="n">MARRIED</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;&lt;/</span><span class="n">tbody</span><span class="o">&gt;&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">table</span> <span class="n">border</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">cellspacing</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="o">&gt;&lt;</span><span class="n">tbody</span><span class="o">&gt;&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;20%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Muni</span><span class="p">:</span> <span class="n">BROWNSTOWN</span> <span class="n">TOWNSHIP</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;20%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span><span class="n">Address</span><span class="p">:</span> <span class="mi">23596</span> <span class="n">STACEY</span> <span class="n">DR</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;20%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span> <span class="n">Tax</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">70065040291000</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="n">td</span> <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;top&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;40%&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;</span>    <span class="n">Subd</span><span class="p">:</span> <span class="n">FLOWERS</span> <span class="n">CREEK</span> <span class="n">NO</span> <span class="mi">3</span>   <span class="n">Liber</span><span class="p">:</span> <span class="mi">114</span>   <span class="n">Page</span><span class="p">:</span> <span class="mi">54</span>    <span class="n">Lot</span><span class="p">:</span> <span class="mi">291</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;&lt;/</span><span class="n">tbody</span><span class="o">&gt;&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">td</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">td</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;clickable&quot;</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../tdd/002-tdd-basics.html" class="btn btn-neutral float-left" title="Intro to unit-testing and test-driven development" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Dan Nguyen, Katlyn Alapati

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>